#!/bin/bash
# Usage: sr <prefix> <gpu_count> [nodelist]
if [ "$#" -lt 2 ] || [ "$#" -gt 3 ]; then
    echo "Usage: sr <prefix> <gpu_count> [nodelist]"
    echo ""
    echo "Examples:"
    echo " sr r3 3        # RTX3090 with 3 GPUs"
    echo " sr r2 2        # RTX2080 with 2 GPUs"
    echo " sr ad 4        # ADA with 4 GPUs"
    echo " sr ti 1        # TITAN with 1 GPU"
    echo " sr r3 2 xoi    # RTX3090 with 2 GPUs on node xoi"
    echo " sr ad 4 tomato # ADA with 4 GPUs on node tomato"
    exit 1
fi

PREFIX=$1
GPU_COUNT=$2
NODELIST=$3

# Validate GPU_COUNT is number
if ! [[ "$GPU_COUNT" =~ ^[0-9]+$ ]]; then
    echo "Error: GPU count must be a number"
    exit 1
fi

# Default per-GPU resources
CPU_PER_GPU=10
MEM_PER_GPU=60 # in GB

# Map prefix to Slurm partition
case "$PREFIX" in
    r3)
        PARTITION="rtx3090"
        ;;
    r2)
        PARTITION="rtx2080"
        ;;
    ad)
        PARTITION="ada"
        ;;
    a1)
        PARTITION="a100"
        ;;
    h1)
        PARTITION="h100"
        ;;
    ti)
        PARTITION="titan"
        ;;
    de)
        PARTITION="dept"
        ;;
    *)
        echo "Unknown prefix: $PREFIX"
        echo "Valid prefixes: r3, r2, ad, a1, h1, ti, de"
        exit 1
        ;;
esac

# Calculate total resources
TOTAL_CPUS=$((GPU_COUNT * CPU_PER_GPU))
TOTAL_MEM_GB=$((GPU_COUNT * MEM_PER_GPU))
TOTAL_MEM="${TOTAL_MEM_GB}G"

# Build srun command
CMD="srun --partition=$PARTITION --nodes=1 --ntasks=1 --cpus-per-task=$TOTAL_CPUS --mem=$TOTAL_MEM --gres=gpu:$GPU_COUNT"

# Add nodelist if provided
if [ -n "$NODELIST" ]; then
    CMD="$CMD --nodelist=$NODELIST"
fi

CMD="$CMD --pty bash"

echo "Running: $CMD"
eval $CMD